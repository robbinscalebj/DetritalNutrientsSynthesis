---
title: "NP_Exploratory"
author: "CJR"
date: '2022-06-14'
output: html_document
---
This markdown starts with base models found in NP_Base_Models.Rmd markdown to explore how covariates might influence the base curves. 

#Setup

Load-in the tidied dataset and packages
```{r setup, include=FALSE}
load("C:/Users/robbi/Dropbox/Detrital Nutrients Synth/Manuscript Dev/Temporal Trends ms/Code/DetNut_Data_for_Analysis.Rdata")

#Read-in libraries
library(tidyverse)
library(janitor)
library(gratia)
library(mgcv)
library(tidymv)
library(RColorBrewer)

```


Need to consider covariate structure
```{r}
ggplot(data=det_loc, aes(x = Temperature_C))+geom_histogram() #Temp is fairly evenly distributed
ggplot(data=det_loc, aes(x = Velocity_m.s))+geom_histogram() #okay coverage, but low quantity
ggplot(data=det_loc, aes(x = pH))+geom_histogram()

ggplot(data=det_loc, aes(x = TN_approx))+geom_histogram() #relatively few data sit above 7500 ug/L, where the rest of the dataset is mostly below 2500 ug/L - it would be appropriate to remove those as they could be strong leveraging points but represent a very small portion of the dataset.
det_loc_tn <- det_loc%>%filter(TN_approx<7500)

ggplot(data=det_loc, aes(x = TP_approx))+geom_histogram() #Again, one grouping of data is very high relative to the rest of the dataset, and could be strong leveraging points, so we will remove those
det_loc_tp <- det_loc%>%filter(TP_approx <2000)

det_loc<-det_loc%>%mutate(N_mass = N_per*Mass_per_remaining)

```


#N mass exploratory models


```{r Ni x Temp}

Ni_base <- gam(data = det_loc, N_mass ~  
               ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                     ti(Mass_per_loss, initial_N, m = 2)+ s(series_index, bs = "re")+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 

Ni_temp_ml <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
               ti(Mass_per_loss,initial_N, Temperature_C, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
                   method = "ML", family = Gamma(link = "inverse"),select = TRUE) 

Ni_temp <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
               ti(Mass_per_loss,initial_N, Temperature_C, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 


summary(Ni_temp)
appraise(Ni_temp)


Ni_T.pred<-predict_gam(type = "link", Ni_temp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_N = c(3,2.0,1.5,1.0,0.6,0.3),Temperature_C = c(5,10,15,20)))%>%
   mutate(Temperature_C = as_factor(Temperature_C), initial_N = as_factor(initial_N))
  


 Ni_T.p<- ggplot()+
    geom_smooth(data = Ni_T.pred, se = FALSE, aes(x = Mass_per_loss, y = 1/fit, color = initial_N, linetype = Temperature_C))+
   facet_grid(initial_N~Temperature_C, scales = "free")+
   geom_ribbon(data = Ni_T.pred, aes(x = Mass_per_loss, ymin = 1/(fit - 2*se.fit), ymax = 1/(fit + 2*se.fit)), alpha = 0.3)+
    geom_abline(slope = -0.01, intercept = 1)+
    NULL
 Ni_T.p
 



```

```{r Ni x pH}

Ni_base <- gam(data = det_loc, N_mass ~  
               ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                     ti(Mass_per_loss, initial_N, m = 2)+ s(series_index, bs = "re")+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 

Ni_ph_ml <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
               ti(Mass_per_loss,initial_N, pH, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "ML", family = Gamma(link = "inverse"),select = TRUE) 

Ni_ph <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
               ti(Mass_per_loss,initial_N, pH, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 


summary(Ni_ph_ml)
appraise(Ni_ph)





```

```{r Ni x TN}


Ni_tn_ml <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
                  ti(Mass_per_loss,initial_N, TN_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "ML", family = Gamma(link = "inverse"),select = TRUE) 

Ni_tn <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
                  ti(Mass_per_loss,initial_N, TN_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 



summary(Ni_tn_ml)
appraise(Ni_tn)


Ni_TN.pred<-predict_gam(type = "link", Ni_tn, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_N = c(3,2,1.5,1.0,0.6,0.3),TN_approx = c(300,600,1000,1500)))%>%
   mutate(TN_approx = as_factor(TN_approx), initial_N = as_factor(initial_N))
  


 Ni_TN.p<- ggplot()+
    geom_smooth(data = Ni_TN.pred, se = FALSE, aes(x = Mass_per_loss, y = 1/fit, color = initial_N, linetype = TN_approx))+
   facet_grid(initial_N~TN_approx, scales = "free")+
   geom_ribbon(data = Ni_TN.pred, aes(x = Mass_per_loss, ymin = 1/(fit - 2*se.fit), ymax = 1/(fit + 2*se.fit)), alpha = 0.3)+
    geom_abline(slope = -0.01, intercept = 1)+
    NULL
 Ni_TN.p
```



```{r Ni x TP}

Ni_tp_ml <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss) + ti(initial_N)+
                  ti(Mass_per_loss, initial_N, m = 2)+
                  ti(Mass_per_loss,initial_N, TP_approx, m = 2)+ 
               s(series_index, Mass_per_loss, bs = "re")+s(series_index, bs = "re"), 
                   method = "ML", family = Gamma(link = "inverse"),select = TRUE)

Ni_tp <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss) + ti(initial_N)+
                  ti(Mass_per_loss, initial_N, m = 2)+
                  ti(Mass_per_loss,initial_N, TP_approx, m = 2)+ 
               s(series_index, Mass_per_loss, bs = "re")+s(series_index, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE)



summary(Ni_tp_ml)
appraise(Ni_tp)


Ni_TP.pred<-predict_gam(type = "link", Ni_tp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_N = c(3,2,1.5,1.0,0.6,0.3),TP_approx = c(50,100,300,500)))%>%
   mutate(TP_approx = as_factor(TP_approx), initial_N = as_factor(initial_N))
  


 Ni_TP.p<- ggplot()+
    geom_smooth(data = Ni_TP.pred, se = FALSE, aes(x = Mass_per_loss, y = 1/fit, color = initial_N, linetype = TP_approx))+
   facet_grid(initial_N~TP_approx, scales = "free")+
   geom_ribbon(data = Ni_TP.pred, aes(x = Mass_per_loss, ymin = 1/(fit - 2*se.fit), ymax = 1/(fit + 2*se.fit)), alpha = 0.3)+
    geom_abline(slope = -0.01, intercept = 1)+
    NULL
 Ni_TP.p
 
```

#CN exploratory models

```{r CN X Temp}
CN_base2 <- gam(data = det_loc, CN_ratio ~ 
                        te(Mass_per_loss, initial_CN, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
             method = "REML", family = Gamma(link = "log"),select = TRUE) 


CN_temp_ml <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, Temperature_C, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "ML", family = Gamma(link = "log"),select = TRUE) 

CN_temp <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, Temperature_C, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "log"),select = TRUE) 

summary(CN_temp_ml)
appraise(CN_temp)


CN_T.pred<-predict_gam(type = "link", CN_temp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_CN = c(140,100,70,50,40,25),Temperature_C = c(7.5,10,15,20)))%>%
   mutate(Temperature_C = as_factor(Temperature_C), initial_CN = as_factor(initial_CN))
  


 CN_T.p<- ggplot()+
    geom_smooth(data = CN_T.pred, se = FALSE, aes(x = Mass_per_loss, y = exp(fit), color = initial_CN, linetype = Temperature_C))+
   facet_grid(initial_CN~Temperature_C, scales = "free")+
   geom_ribbon(data = CN_T.pred, aes(x = Mass_per_loss, ymin = exp(fit - 2*se.fit), ymax = exp(fit + 2*se.fit)), alpha = 0.3)+
   ylab("C:N (molar)")+
   xlab("Mass loss (%)")+
    NULL
 CN_T.p
 
 



```



```{r CN X TN}

CN_tn_ml <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, TN_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "ML", family = Gamma(link = "log"),select = TRUE) 

CN_tn <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, TN_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "log"),select = TRUE) 

summary(CN_tn_ml)
appraise(CN_tn)


CN_TN.pred<-predict_gam(type = "link", CN_tn, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_CN = c(140,100,70,50,40,25),TN_approx = c(300,600,1000,1500)))%>%
   mutate(TN_approx = as_factor(TN_approx), initial_CN = as_factor(initial_CN))
  


 CN_TN.p<- ggplot()+
    geom_smooth(data = CN_TN.pred, se = FALSE, aes(x = Mass_per_loss, y = exp(fit), color = initial_CN, linetype = TN_approx))+
   facet_grid(initial_CN~TN_approx, scales = "free")+
   geom_ribbon(data = CN_TN.pred, aes(x = Mass_per_loss, ymin = exp(fit - 2*se.fit), ymax = exp(fit + 2*se.fit)), alpha = 0.3)+
   ylab("C:N (molar)")+
   xlab("Mass loss (%)")+
    NULL
 CN_TN.p
 

```

```{r CN X TP}



CN_tp_ml <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, TP_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "ML", family = Gamma(link = "log"),select = TRUE) 

CN_tp <- gam(data = det_loc, CN_ratio ~  
                  ti(Mass_per_loss, m = 2, k = 8) + ti(initial_CN, m = 2)+
                  ti(Mass_per_loss, initial_CN, m = 2)+
               ti(Mass_per_loss,initial_CN, TP_approx, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "log"),select = TRUE) 

summary(CN_tp_ml)
appraise(CN_tp)


CN_TP.pred<-predict_gam(type = "link", CN_tp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_CN = c(140,100,70,50,40,25),TP_approx = c(50,100,300,500)))%>%
   mutate(TP_approx = as_factor(TP_approx), initial_CN = as_factor(initial_CN))
  


 CN_TP.p<- ggplot()+
    geom_smooth(data = CN_TP.pred, se = FALSE, aes(x = Mass_per_loss, y = exp(fit), color = initial_CN, linetype = TP_approx))+
   facet_grid(initial_CN~TP_approx, scales = "free")+
   geom_ribbon(data = CN_TP.pred, aes(x = Mass_per_loss, ymin = exp(fit - 2*se.fit), ymax = exp(fit + 2*se.fit)), alpha = 0.3)+
    NULL
 CN_TP.p
 

```

#P mass exploratory models 

None of these will fit - tried all covariates with P and C:P. just not enough data for three-way tensor itneractions 

```{r Pi x Temp}


Pi_temp <- gam(data = det_loc, P_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_P, m = 2)+
                  ti(Mass_per_loss, initial_P, m = 2)+
               ti(Mass_per_loss,initial_P, Temperature_C, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
                   method = "REML", family = gaussian(link = "identity"),select = TRUE) 

Pi_temp <- gam(data = det_loc, P_mass_norm ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_CP, m = 2)+
                  ti(Mass_per_loss, initial_CP, m = 2)+
               ti(Mass_per_loss,initial_CP, TN_approx_avg, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
                   method = "REML", family = gaussian(link = "identity"),select = TRUE) 



summary(Pi_temp))
appraise(Pi_temp)


Ni_T.pred<-predict_gam(type = "link", Ni_temp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_N = c(3,2.0,1.5,1.0,0.6,0.3),Temperature_C = c(5,10,15,20)))%>%
   mutate(Temperature_C = as_factor(Temperature_C), initial_N = as_factor(initial_N))
  


 Ni_T.p<- ggplot()+
    geom_smooth(data = Ni_T.pred, se = FALSE, aes(x = Mass_per_loss, y = 1/fit, color = initial_N, linetype = Temperature_C))+
   facet_grid(initial_N~Temperature_C, scales = "free")+
   geom_ribbon(data = Ni_T.pred, aes(x = Mass_per_loss, ymin = 1/(fit - 2*se.fit), ymax = 1/(fit + 2*se.fit)), alpha = 0.3)+
    geom_abline(slope = -0.01, intercept = 1)+
    NULL
 Ni_T.p
 
 
 Ni_Tonly.pred<-predict_gam(type = "link", Ni_temp, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, Temperature_C = c(5,10,15,20)))%>%
   mutate(Temperature_C = as_factor(Temperature_C))


```
Temperature effects appear for only low N litters - Only at high temps do we really see an increase in litter N.


```{r Ni x TN}

Ni_base <- gam(data = det_loc, N_mass_norm ~  
               ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                     ti(Mass_per_loss, initial_N, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 



Ni_tn <- gam(data = det_loc, N_mass ~  
                  ti(Mass_per_loss, m = 2) + ti(initial_N, m = 2)+
                  ti(Mass_per_loss, initial_N, m = 2)+
                  ti(Mass_per_loss,initial_N, TN_approx_avg, m = 2)+
                        s(series_index, Mass_per_loss, bs = "re")+ s(series_index, bs = "re"), 
                   method = "REML", family = Gamma(link = "inverse"),select = TRUE) 



summary(Ni_tn)
appraise(Ni_tn)


Ni_TN.pred<-predict_gam(type = "link", Ni_tn, length_out = 5000,  exclude_terms = c("s(series_index)", "s(series_index, Mass_per_loss)"), values = list(series_index = NULL,Remain_Mass_Category = NULL, initial_N = c(3,2,1.5,1.0,0.6,0.3),TN_approx_avg = c(300,600,1000,1500)))%>%
   mutate(TN_approx_avg = as_factor(TN_approx_avg), initial_N = as_factor(initial_N))
  


 Ni_TN.p<- ggplot()+
    geom_smooth(data = Ni_TN.pred, se = FALSE, aes(x = Mass_per_loss, y = 1/fit, color = initial_N, linetype = TN_approx_avg))+
   facet_grid(initial_N~TN_approx_avg, scales = "free")+
   geom_ribbon(data = Ni_TN.pred, aes(x = Mass_per_loss, ymin = 1/(fit - 2*se.fit), ymax = 1/(fit + 2*se.fit)), alpha = 0.3)+
    geom_abline(slope = -0.01, intercept = 1)+
    NULL
 Ni_TN.p
```



